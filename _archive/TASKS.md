# Health AI Advisor — TASKS

## プロダクトビジョン
Health Connect のデータを軸に、3人の AI アドバイザー（フィジカルトレーナー・医師・管理栄養士）が
毎日の体・食事・活動データを分析し、一流のレポートを届けるパーソナル健康 AI アプリ。

## AIアドバイザーの基本原則
- **厳しく指示する権威者** ではなく **知識のある優しい友人** として振る舞う
- 小さな前進を積極的に認める
- 提言は「気が向いたら」スタンス。命令しない

---

## ロードマップ概要

| フェーズ | 目的 | 形態 |
|---|---|---|
| **MVP** | 自分が毎日使えるか検証 | ローカル Web（自分専用） |
| **Phase 2** | 価値検証・有料化の土台 | Android アプリ + LLM 自動連携 |
| **Phase 3** | スケール | Play Store リリース + サブスク |
| **Phase 4** | フルプロダクト | クラウド + iOS + 全機能 |

---

## MVP スコープ（現在のフェーズ）

### MVPの定義
> Health Connect の自動同期データ + 手入力の食事・サプリログ → プロンプト自動生成
> → ユーザーが LLM（Claude/ChatGPT）に貼り付けてレポートを取得
> → Web UI に保存・履歴として閲覧できる

**制約：** ローカル PC のみ・自分専用・LLM 自動連携なし（手動）

---

## M1. 既存コード整理（優先度：高）

### 流用するファイル
- `pc-server/app/db.py` — SQLite 基盤、テーブル定義
- `pc-server/app/main.py` — FastAPI アプリ、`/api/sync`
- `pc-server/app/summary.py` — HC データ集計ロジック（体重・歩数・睡眠・カロリー）
- `pc-server/app/security.py` — API キー認証
- `pc-server/app/nutrition.py` — 食事・サプリログ（簡略化して使う）
- `android-app/` — HC 同期コード（そのまま）

### アーカイブ／MVP では使わないもの
- `openclaw_ingest.py` → `_archive/` に移動
- `import_pending.py` / `watch-pending.ps1` → `_archive/` に移動
- `estimator.py` → `_archive/` に移動
- `report.py` の Discord 連携部分 → 削除（新 report エンジンに置き換え）

### 新規追加
- [ ] `user_profile` テーブルを `db.py` に追加
  ```
  user_profile: id, goal_weight_kg, height_cm, birth_year, sex, created_at, updated_at
  ```
- [ ] `ai_reports` テーブルを `db.py` に追加
  ```
  ai_reports: id, report_date, report_type(daily/weekly/monthly),
              prompt_used, content, created_at
  ```
- [ ] 食事ログを MVP 向けに簡略化
  - MVP 入力項目: 食品名・カロリー・P(g)・F(g)・C(g)・食事タイミング（朝/昼/夜/間食）
  - 既存の `nutrition_events` テーブルはそのまま活用
  - 複雑な微量栄養素入力は Phase 2 以降

---

## M2. プロンプト生成エンジン（優先度：高）

> MVP の核心。データを集約して LLM に渡す「お膳立て」をする

### エンドポイント
- [ ] `GET /api/prompt?type=daily` — 日次レポート用プロンプト生成
- [ ] `GET /api/prompt?type=weekly` — 週次レポート用プロンプト生成
- [ ] `GET /api/prompt?type=monthly` — 月次レポート用プロンプト生成

### プロンプトに含める情報
```
[ユーザープロフィール]
身長・現在体重・目標体重・年齢・性別

[期間サマリー（日次なら昨日、週次なら過去7日）]
体重（推移・MA7）
歩数（日別・平均）
活動消費カロリー / 総消費カロリー
睡眠時間（日別・平均）
安静時心拍数（平均）
血圧（平均・最高/最低）
体脂肪率（あれば）
皮膚温（異常値あれば）

[食事ログ]
各食事の食品名・カロリー・PFC
日別合計・期間合計
摂取カロリー vs 消費カロリー 収支

[サプリログ]
服用したサプリ一覧と服用日数

[目標との差分]
目標体重まであと何kg
現在のペース（週あたり変化量）
```

### 出力フォーマット指示（プロンプト末尾に付与）
```
以下の3つの視点でレポートを作成してください。
各アドバイザーは知識のある優しい友人として、
命令せず、励ましながら、具体的な数値根拠を示してください。

■ フィジカルトレーナー
■ 医師
■ 管理栄養士
```

---

## M3. レポート保存・履歴（優先度：高）

- [ ] `POST /api/reports` — AI の返答テキストを受け取って保存
  ```json
  { "report_date": "2026-02-22", "report_type": "daily", "content": "..." }
  ```
- [ ] `GET /api/reports` — レポート一覧（日付・種別）
- [ ] `GET /api/reports/{id}` — レポート本文取得
- [ ] `DELETE /api/reports/{id}` — 削除

---

## M4. Web UI（優先度：高）

> FastAPI から静的ファイルとして配信する。フレームワーク: Vanilla JS + HTML/CSS
> （シンプルに。フロントフレームワーク不要）

### 画面一覧

#### 1. ダッシュボード（トップ）
- [ ] 今日の HC データサマリーカード
  - 体重・体脂肪率・歩数・睡眠・血圧・安静時心拍
- [ ] 体重グラフ（過去30日、MA7 ライン付き）
- [ ] 「レポート生成」ボタン → プロンプト生成画面へ

#### 2. 食事ログ入力
- [ ] 食品名テキスト入力
- [ ] カロリー・P・F・C 入力
- [ ] 食事タイミング選択（朝/昼/夜/間食）
- [ ] 今日の食事一覧表示
- [ ] 編集・削除

#### 3. サプリログ入力
- [ ] サプリマスター登録（名前・1回あたりの栄養素）
- [ ] 今日の服用記録（チェックボックス）
- [ ] 今日の服用一覧

#### 4. プロンプト生成
- [ ] レポートの種別選択（日次/週次/月次）
- [ ] 生成されたプロンプトをテキストエリアに表示
- [ ] 「コピー」ボタン1発
- [ ] → Claude/ChatGPT に貼り付けて返答を取得

#### 5. レポート保存・履歴
- [ ] AI の返答テキストを貼り付けて保存するフォーム
- [ ] レポート一覧（日付・種別でソート・フィルタ）
- [ ] レポート詳細表示
- [ ] Markdown レンダリング対応（レポートが読みやすくなる）

#### 6. プロフィール設定
- [ ] 身長・目標体重・生年月日・性別を入力・保存

---

## M5. Android 同期 実機確認（優先度：中）

既存の Android アプリコードをそのまま実機でテストする。

- [ ] Health Connect 権限をすべて付与
- [ ] PC サーバー（`run.ps1`）を起動して Android からペアリング
- [ ] 全 Record タイプが PC に届くか確認
  - 体重 / 体脂肪 / 歩数 / 睡眠 / 血圧 / 心拍 / 皮膚温 / 消費カロリー
- [ ] 90日バックフィルが正常に完了するか確認
- [ ] 取得できない Record タイプを記録して対処

---

## Phase 2（MVP 完成後に着手）

### Android アプリ本格化
- [ ] Room DB をアプリ内に持つ（PC サーバーなしでも動く）
- [ ] アプリ内で LLM API を直接呼び出す
- [ ] Compose UI でレポート表示・食事ログ画面

### LLM 自動連携
- [ ] API キー設定画面
- [ ] 「レポート生成」→ 自動で LLM に送信→ 表示・保存
- [ ] Claude API / OpenAI API 切り替え対応

### 分析機能強化
- [ ] 体組成グラフ（体重 vs 体脂肪 kg vs 除脂肪体重 kg の分解）
- [ ] 停滞期の自動検知と解説
- [ ] 血圧 × 前日塩分摂取の相関分析
- [ ] 睡眠 × 体重変化の相関分析
- [ ] 栄養素充足率ヒートマップ（週次）
- [ ] サプリ ROI（飲み始めてから何が変わったか）
- [ ] ストレス代理指標（心拍・皮膚温・睡眠の複合）
- [ ] AI チャット機能（「今日だるいのはなぜ？」と聞ける）

### 食事ログ強化
- [ ] 写真 + 食品名 → AI が栄養素を推定（Vision API）
- [ ] お気に入り食品の登録（次回1タップ）
- [ ] 夜の「今日何が足りないか」通知

---

## Phase 3（スケールフェーズ）

### Play Store リリース準備
- [ ] プライバシーポリシー作成・URL 取得
- [ ] Health Connect 権限の Google 審査申請
- [ ] Play Console アカウント開設（$25）
- [ ] アプリアイコン・スクリーンショット・説明文

### サブスクリプション設計
- [ ] Free プラン：HC データ閲覧・手動食事ログ・週1レポート
- [ ] Standard プラン（¥980/月）：毎日レポート・サプリ管理・相関分析
- [ ] Premium プラン（¥1,980/月）：写真食事ログ・AI チャット・PDF 出力

### 毎朝 7 時通知
- [ ] 前日レポートを自動生成・プッシュ通知
- [ ] タップでレポート全文表示

---

## Phase 4（フルプロダクト）

- [ ] クラウドバックエンド（GCP / Railway）
- [ ] iOS 対応
- [ ] 健康診断データ入力（HbA1c・LDL・尿酸値等）と長期追跡
- [ ] 月次 PDF レポート出力（受診時に医師に見せられる形式）
- [ ] 家族プラン
- [ ] 体重予測の信頼区間グラフ
- [ ] 「病院に行くべきか」アドバイス機能

---

## 参考：データソース一覧（Health Connect）

| カテゴリ | データ種別 | デバイス |
|---|---|---|
| 身体測定 | 体重・体脂肪率・基礎代謝・身長 | 体組成計 |
| 主な指標 | 血圧・安静時心拍・心拍数・酸素飽和度・皮膚温 | 血圧計・スマートリング |
| アクティビティ | 歩数・距離・総消費カロリー・活動消費カロリー・運動 | スマートリング |
| 睡眠 | 睡眠時間・睡眠ステージ | スマートリング |
| 食事（手入力） | カロリー・P・F・C | アプリ内入力 |
| サプリ（手入力） | 服用記録・栄養素 | アプリ内入力 |
