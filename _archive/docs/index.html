<!doctype html>
<html lang="ja">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Health Connect Public Dashboard</title>
  <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.1/dist/chart.umd.min.js"></script>
  <style>
    :root {
      --bg: #0a1324;
      --panel: #12213b;
      --line: rgba(120, 156, 214, 0.22);
      --text: #ecf3ff;
      --muted: #9fb3d8;
      --ok: #66ff8f;
      --accent: #7cc6ff;
      --warn: #ffbf7a;
      --danger: #ff8ea4;
    }
    * { box-sizing: border-box; }
    body {
      margin: 0;
      color: var(--text);
      font-family: "Segoe UI", "Noto Sans JP", sans-serif;
      background: radial-gradient(circle at 10% 0%, #1b3a68 0, rgba(27,58,104,0) 40%), linear-gradient(180deg, #0a1324, #070d18);
      min-height: 100vh;
    }
    .wrap {
      max-width: 1200px;
      margin: 0 auto;
      padding: 18px;
      display: grid;
      gap: 12px;
    }
    .head {
      display: flex;
      justify-content: space-between;
      align-items: center;
      gap: 12px;
      flex-wrap: wrap;
    }
    .title h1 { margin: 0; font-size: 30px; }
    .sub { color: var(--muted); font-size: 13px; margin-top: 4px; }
    .control-stack { display: grid; gap: 8px; justify-items: end; }
    .toggle {
      display: inline-flex;
      border: 1px solid var(--line);
      border-radius: 10px;
      overflow: hidden;
      background: rgba(12, 24, 45, 0.9);
    }
    .toggle button {
      border: 0;
      background: transparent;
      color: var(--muted);
      padding: 8px 14px;
      font-size: 13px;
      font-weight: 700;
      cursor: pointer;
    }
    .toggle button.on {
      color: #07220f;
      background: linear-gradient(180deg, #8fff9a, #55ed73);
    }
    .banner {
      border: 1px solid #2f5786;
      border-radius: 10px;
      background: rgba(93, 232, 138, 0.08);
      color: #dbffe5;
      padding: 10px 12px;
      font-size: 13px;
    }
    .error {
      display: none;
      border: 1px solid rgba(255, 142, 164, 0.45);
      border-radius: 10px;
      background: rgba(255, 110, 140, 0.15);
      color: #ffdbe3;
      padding: 10px 12px;
      font-size: 13px;
    }
    .view { display: none; gap: 12px; }
    .view.on { display: grid; }
    .kpis {
      display: grid;
      grid-template-columns: repeat(4, minmax(0, 1fr));
      gap: 10px;
    }
    .card {
      border: 1px solid var(--line);
      border-radius: 12px;
      background: linear-gradient(165deg, rgba(18, 33, 59, .96), rgba(10, 18, 34, .96));
      padding: 12px;
    }
    .label { color: var(--muted); font-size: 12px; }
    .value {
      margin-top: 4px;
      font-size: 28px;
      line-height: 1.1;
      font-weight: 800;
      color: #f5f9ff;
    }
    .unit { margin-left: 4px; color: var(--muted); font-size: 12px; }
    .panels {
      display: grid;
      grid-template-columns: repeat(2, minmax(0, 1fr));
      gap: 10px;
    }
    .panel {
      border: 1px solid var(--line);
      border-radius: 12px;
      background: linear-gradient(165deg, rgba(18, 33, 59, .96), rgba(10, 18, 34, .96));
      padding: 12px;
      min-width: 0;
    }
    .panel h3 { margin: 0 0 8px; font-size: 16px; }
    .canvas { height: 300px; }
    .insights {
      margin: 0;
      padding: 0;
      list-style: none;
      display: grid;
      gap: 8px;
    }
    .insights li {
      border: 1px solid #30527c;
      border-radius: 10px;
      background: rgba(15, 41, 70, .5);
      padding: 9px 10px;
      display: grid;
      grid-template-columns: auto 1fr;
      gap: 8px;
      align-items: start;
      font-size: 13px;
    }
    .badge {
      font-size: 11px;
      border-radius: 999px;
      padding: 3px 7px;
      font-weight: 700;
      line-height: 1;
      align-self: center;
    }
    .badge.warn { color: #2f1700; background: var(--warn); }
    .badge.info { color: #06253f; background: var(--accent); }
    .nutri-controls {
      display: flex;
      gap: 8px;
      align-items: end;
      flex-wrap: wrap;
      margin-bottom: 8px;
    }
    .nutri-controls input {
      border: 1px solid var(--line);
      border-radius: 8px;
      background: rgba(10, 19, 36, .8);
      color: var(--text);
      padding: 7px 9px;
    }
    .btn {
      border: 0;
      border-radius: 8px;
      padding: 8px 12px;
      background: linear-gradient(180deg, #8fff9a, #55ed73);
      color: #07220f;
      font-weight: 700;
      cursor: pointer;
    }
    .table-wrap {
      max-height: 380px;
      overflow: auto;
      border: 1px solid var(--line);
      border-radius: 10px;
    }
    table {
      width: 100%;
      border-collapse: collapse;
      font-size: 13px;
    }
    th, td {
      text-align: left;
      padding: 7px 8px;
      border-bottom: 1px solid rgba(120, 156, 214, 0.2);
    }
    th {
      position: sticky;
      top: 0;
      background: rgba(10, 18, 34, .96);
      color: var(--muted);
    }
    .foot {
      color: var(--muted);
      font-size: 12px;
      border-top: 1px solid var(--line);
      padding-top: 10px;
      line-height: 1.8;
    }
    @media (max-width: 980px) {
      .kpis { grid-template-columns: repeat(2, minmax(0, 1fr)); }
      .panels { grid-template-columns: 1fr; }
      .title h1 { font-size: 24px; }
      .canvas { height: 260px; }
    }
  </style>
</head>
<body>
  <div class="wrap">
    <div class="head">
      <div class="title">
        <h1>Health Dashboard</h1>
        <div id="meta" class="sub">loading...</div>
        <div id="kpiMode" class="sub">KPI mode</div>
      </div>
      <div class="control-stack">
        <div class="toggle">
          <button class="v on" data-v="overview">Overview</button>
          <button class="v" data-v="nutrition">Nutrition</button>
        </div>
        <div class="toggle">
          <button class="r on" data-r="day">Day</button>
          <button class="r" data-r="week">Week</button>
          <button class="r" data-r="month">Month</button>
        </div>
      </div>
    </div>

    <section id="view-overview" class="view on">
      <div class="banner">
        Public dashboard view. Source: <code>docs/data/summary.json</code>
      </div>
      <div id="err" class="error"></div>

      <section class="kpis">
        <article class="card"><div class="label">Weight</div><div class="value"><span id="w">-</span><span class="unit">kg</span></div></article>
        <article class="card"><div class="label">Steps</div><div class="value"><span id="s">-</span><span class="unit">steps</span></div></article>
        <article class="card"><div class="label">Burned / Intake</div><div class="value"><span id="c">-</span><span class="unit">kcal</span></div></article>
        <article class="card"><div class="label">Sleep</div><div class="value"><span id="sl">-</span><span class="unit">h</span></div></article>
      </section>

      <section class="panels">
        <article class="panel">
          <h3>Weight Trend</h3>
          <div class="canvas"><canvas id="weightChart"></canvas></div>
        </article>
        <article class="panel">
          <h3>Calories</h3>
          <div class="canvas"><canvas id="calChart"></canvas></div>
        </article>
      </section>

      <section class="panel">
        <h3>Insights</h3>
        <ul id="insights" class="insights"></ul>
      </section>
    </section>

    <section id="view-nutrition" class="view">
      <section class="panel">
        <h3>Nutrition Details</h3>
        <div class="sub">Daily totals from exported nutrition data</div>
        <div class="nutri-controls">
          <label class="sub">Date<br /><input id="nutritionDay" type="date" /></label>
          <button id="nutritionRefresh" class="btn">Refresh</button>
          <span id="nutritionMsg" class="sub">-</span>
        </div>
      </section>

      <section class="kpis">
        <article class="card"><div class="label">Total kcal</div><div class="value"><span id="nK">-</span><span class="unit">kcal</span></div></article>
        <article class="card"><div class="label">Protein</div><div class="value"><span id="nP">-</span><span class="unit">g</span></div></article>
        <article class="card"><div class="label">Fat</div><div class="value"><span id="nF">-</span><span class="unit">g</span></div></article>
        <article class="card"><div class="label">Carbs</div><div class="value"><span id="nC">-</span><span class="unit">g</span></div></article>
      </section>

      <section class="panel">
        <h3>Micronutrients</h3>
        <div class="table-wrap">
          <table id="nMicrosTable"></table>
        </div>
      </section>
    </section>

    <div class="foot">
      <div>Data: <code>docs/data/summary.json</code></div>
      <div>Refresh source file: <code>cd pc-server; python export_public_summary.py</code></div>
    </div>
  </div>

  <script>
    const S = { raw: null, range: "week", view: "overview" };
    const CH = {};
    const C = {
      green: "#66ff8f",
      blue: "#7cc6ff",
      orange: "#ffbf7a",
      red: "#ff8ea4",
      purple: "#b9a7ff",
    };

    const fmt0 = (v) => (v === null || v === undefined || Number.isNaN(Number(v)) ? "-" : Math.round(Number(v)).toLocaleString("ja-JP"));
    const fmt1 = (v) => (v === null || v === undefined || Number.isNaN(Number(v)) ? "-" : (Math.round(Number(v) * 10) / 10).toLocaleString("ja-JP"));
    const days = () => (S.range === "day" ? 1 : S.range === "week" ? 7 : 30);
    const todayStr = () => new Date().toISOString().slice(0, 10);

    function useRows() {
      const arr = Array.isArray(S.raw?.metrics) ? S.raw.metrics : [];
      const n = days();
      return n >= arr.length ? arr : arr.slice(-n);
    }

    function nutritionRows() {
      const arr = Array.isArray(S.raw?.nutritionDaily) ? S.raw.nutritionDaily : [];
      return arr.slice().sort((a, b) => String(a.day).localeCompare(String(b.day)));
    }

    function dayLabel(day) {
      if (typeof day !== "string") return String(day ?? "");
      const m = /^(\d{4})-(\d{2})-(\d{2})$/.exec(day);
      if (!m) return day;
      return `${Number(m[2])}/${Number(m[3])}`;
    }

    function labels(rows) { return rows.map((x) => dayLabel(x.day)); }
    function vals(rows, key) { return rows.map((x) => x[key] ?? null); }

    function opts() {
      return {
        responsive: true,
        maintainAspectRatio: false,
        interaction: { mode: "index", intersect: false },
        scales: {
          x: { ticks: { color: "rgba(220,232,255,.84)" }, grid: { color: "rgba(85,118,167,.16)" } },
          y: { ticks: { color: "rgba(220,232,255,.84)" }, grid: { color: "rgba(85,118,167,.16)" } },
        },
        plugins: {
          legend: { labels: { color: "rgba(234,241,255,.92)", usePointStyle: true } },
          tooltip: {
            backgroundColor: "rgba(8,17,33,.95)",
            borderColor: "rgba(98,132,183,.6)",
            borderWidth: 1,
          },
        },
      };
    }

    function draw(id, type, ls, datasets, customOpts) {
      if (CH[id]) CH[id].destroy();
      CH[id] = new Chart(document.getElementById(id), {
        type,
        data: { labels: ls, datasets },
        options: customOpts || opts(),
      });
    }

    function setText(id, value) {
      const el = document.getElementById(id);
      if (el) el.textContent = value;
    }

    function showError(msg) {
      const e = document.getElementById("err");
      if (!e) return;
      e.style.display = "block";
      e.textContent = msg;
    }

    function fillInsights(items) {
      const ul = document.getElementById("insights");
      ul.innerHTML = "";
      if (!Array.isArray(items) || !items.length) {
        const li = document.createElement("li");
        const badge = document.createElement("span");
        badge.className = "badge info";
        badge.textContent = "INFO";
        const text = document.createElement("span");
        text.textContent = "No insights available.";
        li.appendChild(badge);
        li.appendChild(text);
        ul.appendChild(li);
        return;
      }
      items.forEach((item) => {
        const level = (item?.level || "info").toLowerCase() === "warn" ? "warn" : "info";
        const badge = document.createElement("span");
        badge.className = `badge ${level}`;
        badge.textContent = level === "warn" ? "WARN" : "INFO";
        const text = document.createElement("span");
        text.textContent = typeof item?.message === "string" ? item.message : "-";
        const li = document.createElement("li");
        li.appendChild(badge);
        li.appendChild(text);
        ul.appendChild(li);
      });
    }

    function setView(nextView) {
      const v = nextView === "nutrition" ? "nutrition" : "overview";
      S.view = v;
      const o = document.getElementById("view-overview");
      const n = document.getElementById("view-nutrition");
      if (o) o.classList.toggle("on", v === "overview");
      if (n) n.classList.toggle("on", v === "nutrition");
      document.querySelectorAll(".v").forEach((b) => {
        b.classList.toggle("on", b.dataset.v === v);
      });
      if (v === "nutrition") renderNutrition();
    }

    function renderOverview() {
      const rows = useRows();
      if (!rows.length) {
        showError("No metrics available in summary.json");
        return;
      }

      setText("kpiMode", S.range === "day" ? "KPI mode: latest day" : "KPI mode: range average");
      const latest = rows[rows.length - 1] || {};
      const mean = (key) => {
        if (S.range === "day") return latest[key] ?? null;
        const arr = rows
          .map((x) => x?.[key])
          .filter((v) => v !== null && v !== undefined && !Number.isNaN(Number(v)))
          .map((v) => Number(v));
        if (!arr.length) return latest[key] ?? null;
        return arr.reduce((a, b) => a + b, 0) / arr.length;
      };

      setText("w", fmt1(latest.weightKg));
      setText("s", fmt0(mean("steps")));
      setText("c", `${fmt0(mean("totalCaloriesKcal"))} / ${fmt0(mean("intakeCaloriesKcal"))}`);
      setText("sl", fmt1(mean("sleepHours")));

      const l = labels(rows);
      const singleDay = rows.length === 1;
      const targetWeight = Number(S.raw?.goals?.targetWeightKg ?? 75);
      draw("weightChart", singleDay ? "bar" : "line", l, [
        {
          type: singleDay ? "bar" : "line",
          label: "Weight",
          data: vals(rows, "weightKg"),
          borderColor: C.green,
          backgroundColor: singleDay ? "rgba(102,255,143,.4)" : "rgba(102,255,143,.16)",
          fill: !singleDay,
          pointRadius: 2,
          tension: .25,
        },
        {
          type: "line",
          label: "Target",
          data: l.map(() => targetWeight),
          borderColor: C.orange,
          borderDash: [6, 4],
          pointRadius: 0,
          tension: 0,
        },
      ]);

      draw("calChart", "bar", l, [
        { label: "Burned", data: vals(rows, "totalCaloriesKcal"), backgroundColor: "rgba(255,142,164,.42)", borderColor: C.red },
        { label: "Intake", data: vals(rows, "intakeCaloriesKcal"), backgroundColor: "rgba(124,198,255,.42)", borderColor: C.blue },
        { label: "Balance", data: vals(rows, "calorieBalanceKcal"), backgroundColor: "rgba(255,191,122,.42)", borderColor: C.orange },
      ]);

      fillInsights(S.raw?.insights);
    }

    function renderNutrition() {
      const dayInput = document.getElementById("nutritionDay");
      const msg = document.getElementById("nutritionMsg");
      const table = document.getElementById("nMicrosTable");
      if (!dayInput || !msg || !table) return;

      const rows = nutritionRows();
      if (!rows.length) {
        setText("nK", "-");
        setText("nP", "-");
        setText("nF", "-");
        setText("nC", "-");
        table.innerHTML = "<tr><th>Nutrient</th><th>Total</th></tr><tr><td colspan='2'>No nutrition data</td></tr>";
        msg.textContent = "No nutritionDaily in summary.json";
        return;
      }

      const daysAvailable = new Set(rows.map((r) => String(r.day)));
      if (!dayInput.value || !daysAvailable.has(dayInput.value)) {
        dayInput.value = String(rows[rows.length - 1].day || todayStr());
      }
      const row = rows.find((r) => String(r.day) === dayInput.value) || rows[rows.length - 1];

      setText("nK", fmt1(row.kcal));
      setText("nP", fmt1(row.protein_g));
      setText("nF", fmt1(row.fat_g));
      setText("nC", fmt1(row.carbs_g));

      const micros = row && typeof row.micros === "object" && row.micros
        ? Object.entries(row.micros).filter(([, v]) => Number.isFinite(Number(v)))
        : [];
      micros.sort((a, b) => Number(b[1]) - Number(a[1]));

      table.innerHTML = "<tr><th>Nutrient</th><th>Total</th></tr>";
      if (!micros.length) {
        const tr = document.createElement("tr");
        tr.innerHTML = "<td colspan='2'>No micronutrients</td>";
        table.appendChild(tr);
      } else {
        micros.forEach(([k, v]) => {
          const tr = document.createElement("tr");
          tr.innerHTML = "<td>" + k + "</td><td>" + fmt1(v) + "</td>";
          table.appendChild(tr);
        });
      }

      msg.textContent = `${dayInput.value} | micros: ${micros.length}`;
    }

    function render() {
      if (!S.raw) return;
      setView(S.view);
      renderOverview();
      if (S.view === "nutrition") renderNutrition();
    }

    async function load() {
      try {
        const r = await fetch("./data/summary.json?ts=" + Date.now());
        if (!r.ok) throw new Error("summary.json fetch failed: " + r.status);
        S.raw = await r.json();
        const p = S.raw?.privacy || {};
        setText("meta", `generatedAt: ${S.raw?.generatedAt || "-"} / dateMode: ${p.dateMode || "-"} / gps: ${p.containsGps ? "yes" : "no"}`);
        const d = document.getElementById("nutritionDay");
        if (d && !d.value) d.value = todayStr();
        render();
      } catch (e) {
        showError((e && e.message) ? e.message : String(e));
      }
    }

    document.querySelectorAll(".r").forEach((b) => {
      b.addEventListener("click", () => {
        document.querySelectorAll(".r").forEach((x) => x.classList.remove("on"));
        b.classList.add("on");
        S.range = b.dataset.r;
        renderOverview();
      });
    });

    document.querySelectorAll(".v").forEach((b) => {
      b.addEventListener("click", () => setView(b.dataset.v));
    });

    document.getElementById("nutritionRefresh").addEventListener("click", renderNutrition);
    document.getElementById("nutritionDay").addEventListener("change", renderNutrition);

    load();
  </script>
</body>
</html>
