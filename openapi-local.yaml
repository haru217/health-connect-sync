openapi: 3.1.0
info:
  title: Health Connect Sync Bridge (Local PC) API
  version: 0.1.0
  description: |
    Local (LAN) ingestion API running on a PC.
    
    Auth: X-Api-Key header.
servers:
  - url: http://{host}:{port}
    variables:
      host:
        default: 192.168.0.10
      port:
        default: '8765'

components:
  securitySchemes:
    apiKeyAuth:
      type: apiKey
      in: header
      name: X-Api-Key

  schemas:
    ErrorResponse:
      type: object
      additionalProperties: false
      properties:
        error:
          type: string
        message:
          type: string
      required: [error, message]

    RecordEnvelope:
      type: object
      additionalProperties: false
      properties:
        type:
          type: string
          description: Health Connect Record class name (e.g. StepsRecord)
        recordId:
          type: string
          nullable: true
        recordKey:
          type: string
          nullable: true
          description: Optional stable idempotency key; if omitted server computes.
        source:
          type: string
          nullable: true
        startTime:
          type: string
          format: date-time
          nullable: true
        endTime:
          type: string
          format: date-time
          nullable: true
        time:
          type: string
          format: date-time
          nullable: true
        lastModifiedTime:
          type: string
          format: date-time
          nullable: true
        unit:
          type: string
          nullable: true
        payload:
          type: object
          additionalProperties: true
      required: [type, payload]

    SyncRequest:
      type: object
      additionalProperties: false
      properties:
        deviceId:
          type: string
        syncId:
          type: string
          description: UUID identifying this sync run
        syncedAt:
          type: string
          format: date-time
        rangeStart:
          type: string
          format: date-time
        rangeEnd:
          type: string
          format: date-time
        records:
          type: array
          items:
            $ref: '#/components/schemas/RecordEnvelope'
      required: [deviceId, syncId, syncedAt, rangeStart, rangeEnd, records]

    SyncResponse:
      type: object
      additionalProperties: false
      properties:
        accepted:
          type: boolean
        upsertedCount:
          type: integer
        skippedCount:
          type: integer
      required: [accepted, upsertedCount, skippedCount]

    Insight:
      type: object
      additionalProperties: false
      properties:
        level:
          type: string
          enum: [info, warn]
        message:
          type: string
      required: [level, message]
      description: Heuristic hint for dieting dashboard

    StatusResponse:
      type: object
      additionalProperties: false
      properties:
        ok:
          type: boolean
        dbPath:
          type: string
        totalRecords:
          type: integer
        lastReceivedAt:
          type: string
          format: date-time
          nullable: true
        lastSyncId:
          type: string
          nullable: true
      required: [ok, dbPath, totalRecords]

    DietSummary:
      type: object
      additionalProperties: true
      description: Diet-oriented trend summary (heuristic)

    SummaryResponse:
      type: object
      additionalProperties: true
      description: Summary payload for dashboard

    OpenClawIngestItem:
      type: object
      additionalProperties: true
      properties:
        alias:
          type: string
          nullable: true
        label:
          type: string
          nullable: true
        count:
          type: number
          nullable: true
        note:
          type: string
          nullable: true
        local_date:
          type: string
          nullable: true
          description: Local date in YYYY-MM-DD.
        consumed_at:
          type: string
          format: date-time
          nullable: true
      description: One nutrition item (alias or custom label item).

    OpenClawIngestRequest:
      type: object
      additionalProperties: true
      properties:
        event_id:
          type: string
          description: Stable idempotency key for this OpenClaw ingest event.
        source:
          type: string
          nullable: true
          description: Optional source label. Defaults to openclaw.
        local_date:
          type: string
          nullable: true
          description: Optional fallback date for items (YYYY-MM-DD).
        intake_kcal:
          type: number
          nullable: true
          description: Optional daily intake kcal upsert for local_date.
        intake_note:
          type: string
          nullable: true
        items:
          type: array
          items:
            $ref: '#/components/schemas/OpenClawIngestItem'
      required: [event_id, items]

    OpenClawIngestResponse:
      type: object
      additionalProperties: false
      properties:
        ok:
          type: boolean
        ingested:
          type: integer
        duplicate:
          type: integer
        eventId:
          type: string
      required: [ok, ingested, duplicate, eventId]

    Profile:
      type: object
      additionalProperties: false
      properties:
        id:
          type: integer
        name:
          type: string
          nullable: true
        height_cm:
          type: number
          nullable: true
        birth_year:
          type: integer
          nullable: true
        sex:
          type: string
          enum: [male, female, other]
          nullable: true
        goal_weight_kg:
          type: number
          nullable: true
        updated_at:
          type: string
          format: date-time
      required: [id, updated_at]

    ProfileUpdateRequest:
      type: object
      additionalProperties: false
      properties:
        name:
          type: string
        height_cm:
          type: number
          minimum: 50
          maximum: 250
        birth_year:
          type: integer
          minimum: 1900
          maximum: 2020
        sex:
          type: string
          enum: [male, female, other]
        goal_weight_kg:
          type: number
          minimum: 20
          maximum: 300

    PromptResponse:
      type: object
      additionalProperties: false
      properties:
        type:
          type: string
          enum: [daily, weekly, monthly]
        prompt:
          type: string
      required: [type, prompt]

    ReportSaveRequest:
      type: object
      additionalProperties: false
      properties:
        report_date:
          type: string
          pattern: ^\d{4}-\d{2}-\d{2}$
        report_type:
          type: string
          enum: [daily, weekly, monthly]
        prompt_used:
          type: string
        content:
          type: string
      required: [report_date, report_type, prompt_used, content]

    Report:
      type: object
      additionalProperties: false
      properties:
        id:
          type: integer
        report_date:
          type: string
        report_type:
          type: string
          enum: [daily, weekly, monthly]
        prompt_used:
          type: string
        content:
          type: string
        created_at:
          type: string
          format: date-time
      required: [id, report_date, report_type, prompt_used, content, created_at]

    ReportListItem:
      type: object
      additionalProperties: false
      properties:
        id:
          type: integer
        report_date:
          type: string
        report_type:
          type: string
          enum: [daily, weekly, monthly]
        created_at:
          type: string
          format: date-time
        preview:
          type: string
      required: [id, report_date, report_type, created_at, preview]

    ReportsListResponse:
      type: object
      additionalProperties: false
      properties:
        reports:
          type: array
          items:
            $ref: '#/components/schemas/ReportListItem'
      required: [reports]

    SupplementsResponse:
      type: object
      additionalProperties: false
      properties:
        supplements:
          type: array
          items:
            type: object
            additionalProperties: false
            properties:
              alias:
                type: string
              label:
                type: string
              kcal:
                type: number
                nullable: true
              protein_g:
                type: number
                nullable: true
              fat_g:
                type: number
                nullable: true
              carbs_g:
                type: number
                nullable: true
            required: [alias, label]
      required: [supplements]

    NutrientTarget:
      type: object
      additionalProperties: false
      properties:
        key:
          type: string
        name:
          type: string
        unit:
          type: string
        target:
          type: number
        actual:
          type: number
          nullable: true
        status:
          type: string
          enum: [green, yellow, red]
      required: [key, name, unit, target, status]

    NutrientTargetsResponse:
      type: object
      additionalProperties: false
      properties:
        targets:
          type: array
          items:
            $ref: '#/components/schemas/NutrientTarget'
      required: [targets]

paths:
  /api/profile:
    get:
      summary: Get user profile (single row id=1)
      security:
        - apiKeyAuth: []
      responses:
        '200':
          description: OK
          content:
            application/json:
              schema:
                oneOf:
                  - type: object
                    maxProperties: 0
                  - $ref: '#/components/schemas/Profile'
        '401':
          description: Unauthorized
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'
    put:
      summary: Upsert user profile (partial update)
      security:
        - apiKeyAuth: []
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/ProfileUpdateRequest'
      responses:
        '200':
          description: Updated profile
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Profile'
        '401':
          description: Unauthorized
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'
        '422':
          description: Validation error

  /api/supplements:
    get:
      summary: List supplement catalog
      security:
        - apiKeyAuth: []
      responses:
        '200':
          description: OK
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/SupplementsResponse'
        '401':
          description: Unauthorized
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'

  /api/prompt:
    get:
      summary: Generate LLM prompt text from profile, HC summary, and nutrition logs
      security:
        - apiKeyAuth: []
      parameters:
        - in: query
          name: type
          required: false
          schema:
            type: string
            enum: [daily, weekly, monthly]
            default: daily
      responses:
        '200':
          description: OK
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/PromptResponse'
        '400':
          description: Invalid type
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'
        '401':
          description: Unauthorized
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'

  /api/reports:
    post:
      summary: Save generated AI report
      security:
        - apiKeyAuth: []
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/ReportSaveRequest'
      responses:
        '201':
          description: Created
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Report'
        '401':
          description: Unauthorized
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'
        '422':
          description: Validation error
    get:
      summary: List saved AI reports (preview only)
      security:
        - apiKeyAuth: []
      parameters:
        - in: query
          name: report_type
          required: false
          schema:
            type: string
            enum: [daily, weekly, monthly]
      responses:
        '200':
          description: OK
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ReportsListResponse'
        '401':
          description: Unauthorized
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'

  /api/reports/{report_id}:
    get:
      summary: Get one saved report by id
      security:
        - apiKeyAuth: []
      parameters:
        - in: path
          name: report_id
          required: true
          schema:
            type: integer
      responses:
        '200':
          description: OK
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Report'
        '401':
          description: Unauthorized
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'
        '404':
          description: Not found
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'
    delete:
      summary: Delete one saved report by id
      security:
        - apiKeyAuth: []
      parameters:
        - in: path
          name: report_id
          required: true
          schema:
            type: integer
      responses:
        '200':
          description: OK
          content:
            application/json:
              schema:
                type: object
                additionalProperties: false
                properties:
                  ok:
                    type: boolean
                  deleted_id:
                    type: integer
                required: [ok, deleted_id]
        '401':
          description: Unauthorized
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'

  /api/nutrients/targets:
    get:
      summary: Calculate daily nutrient targets and compare with today's actuals
      security:
        - apiKeyAuth: []
      responses:
        '200':
          description: OK
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/NutrientTargetsResponse'
        '400':
          description: Profile missing or incomplete
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'
        '401':
          description: Unauthorized
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'

  /api/nutrition/day:
    get:
      summary: Get nutrition events for a local date
      security:
        - apiKeyAuth: []
      parameters:
        - in: query
          name: date
          required: true
          schema:
            type: string
          description: Local date (YYYY-MM-DD)
      responses:
        '200':
          description: OK
          content:
            application/json:
              schema:
                type: object

  /api/nutrition/log:
    post:
      summary: Log manual nutrition/supplement event(s)
      security:
        - apiKeyAuth: []
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
              description: |
                Payload examples:
                - {"alias":"protein","count":1}
                - {"items":[{"alias":"protein","count":1},{"alias":"vitamin_d","count":1}]}
                - {"label":"rice","count":1,"kcal":300,"protein_g":6,"fat_g":1,"carbs_g":70}
      responses:
        '200':
          description: OK
          content:
            application/json:
              schema:
                type: object

  /api/openclaw/ingest:
    post:
      summary: Ingest OpenClaw nutrition event (idempotent by event_id)
      security:
        - apiKeyAuth: []
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/OpenClawIngestRequest'
      responses:
        '200':
          description: Accepted
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/OpenClawIngestResponse'
        '400':
          description: Bad request
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'
        '401':
          description: Unauthorized
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'

  /api/report/yesterday:
    get:
      summary: Yesterday report (text; includes manual nutrition PFC+micros)
      security:
        - apiKeyAuth: []
      responses:
        '200':
          description: OK
          content:
            application/json:
              schema:
                type: object
                properties:
                  text:
                    type: string

  /api/status:
    get:
      summary: Server status
      security:
        - apiKeyAuth: []
      responses:
        '200':
          description: OK
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/StatusResponse'
        '401':
          description: Unauthorized
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'

  /api/sync:
    post:
      summary: Ingest a sync batch (idempotent upsert)
      security:
        - apiKeyAuth: []
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/SyncRequest'
      responses:
        '200':
          description: Accepted
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/SyncResponse'
        '400':
          description: Bad request
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'
        '401':
          description: Unauthorized
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'

  /api/summary:
    get:
      summary: Summary (diet-oriented metrics + insights)
      security:
        - apiKeyAuth: []
      responses:
        '200':
          description: OK
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/SummaryResponse'

  /ui:
    get:
      summary: Minimal HTML dashboard (prompts for API key)
      responses:
        '200':
          description: HTML
          content:
            text/html:
              schema:
                type: string

  /api/export.csv:
    get:
      summary: Export records as CSV (raw payload JSON)
      security:
        - apiKeyAuth: []
      parameters:
        - in: query
          name: type
          schema:
            type: string
          required: false
          description: Filter by record type.
      responses:
        '200':
          description: CSV
          content:
            text/csv:
              schema:
                type: string
        '401':
          description: Unauthorized
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'
